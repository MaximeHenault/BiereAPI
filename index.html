<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="styles.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <title>Beer List</title>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="index.html">Like Beer</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="index.html">Home page</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="add-bear.html">Add beer</a>
            </li>
          </ul>
          <form class="d-flex align-items-center">
              <input type="text" class="form-control me-2 shadow-sm" id="searchInput"
                    placeholder="ðŸº Search a beer...">
          </form>
          <button>Installe moi stp</button>
        </div>
      </div>
    </nav>
    <div class="container mt-5">
      <h1>Home Pages</h1>
      <!-- Beer List -->
      <div class="row" id="beerList"></div>
    </div>
    <div>
      <button></button>
      <p></p>
      <button></button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"></script>
      <script src="app.js"></script>
    <script>
      window.addEventListener("load", async (event) => {
      /**************************
       ***         MODEL
      ***************************/
      // Initialisation de la base de donnÃ©es
      const db = await initDB();

      async function initDB() {
        console.log("creation de la db");
        return new Promise((resolve, reject) => {
          
          const request = indexedDB.open('BeerDB', 1);
          request.onupgradeneeded = (event) => {
            const db = event.target.result;
            const store = db.createObjectStore('beers', { keyPath: 'id' });
            store.createIndex('name', 'name', { unique: false });
          };

          request.onsuccess = (event) => {
            resolve(event.target.result);
          };

          request.onerror = (event) => {
            reject('Error opening IndexedDB');
          };
        });
      }

      // Fonction pour ajouter une biÃ¨re Ã  la base de donnÃ©es
      async function addToDB(beer) {
        const transaction = db.transaction(['beers'], 'readwrite');
        const store = transaction.objectStore('beers');
        await store.add(beer);
      }

      // Fonction pour rÃ©cupÃ©rer les biÃ¨res depuis la base de donnÃ©es
      async function getBeersFromDB() {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction(['beers'], 'readonly');
          const store = transaction.objectStore('beers');
          const request = store.getAll();

          request.onsuccess = (event) => {
            resolve(event.target.result);
          };

          request.onerror = (event) => {
            reject('Error fetching beers from IndexedDB');
          };
        });
      }

      // Function to fetch beers from Punk API
      async function modelFetchBeers(id) {
        // Essayer de rÃ©cupÃ©rer les biÃ¨res depuis la base de donnÃ©es
        try {
          beers = await getBeersFromDB();

          // Si la base de donnÃ©es est vide, rÃ©cupÃ©rer depuis l'API et ajouter Ã  la base de donnÃ©es
          if (beers.length === 0) {
            beers = await fetch(`https://punkapi.online/v3/beers?page=${id}`)
              .then(response => response.json())
              .then(data => {
                data.forEach(async (beer) => {
                  await addToDB(beer);
                });
                return data;
              })
              .catch(error => console.error('Error fetching beers:', error));
          }

          displayBeers(beers);
        } catch (error) {
          console.error(error);
        }
      }
      // Ajoutez control si nÃ©cessaire puis appelez le modÃ¨le
      modelFetchBeers(1);
    });

  if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
      .then(registration => {
          console.log('Service Worker enregistrÃ© avec succÃ¨s.', registration);
      })
      .catch(error => {
          console.log("Erreur lors de l'enregistrement du Service Worker.", error);
      });
  }
    </script>
</body>
</html>